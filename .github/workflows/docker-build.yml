name: Build and Push Docker Images

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  SCRAPER_IMAGE: ${{ github.repository }}
  UI_IMAGE: ${{ github.repository }}-ui

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      scraper: ${{ steps.filter.outputs.scraper }}
      ui: ${{ steps.filter.outputs.ui }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for changes
      uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          scraper:
            - 'src/**'
            - 'config/**'
            - 'Dockerfile'
            - 'package.json'
            - 'package-lock.json'
            - 'tsconfig.json'
          ui:
            - 'ui/**'

  build-and-push-scraper:
    name: Build Scraper Image
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.scraper == 'true'
    permissions:
      contents: read
      packages: write
      actions: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for scraper
      id: meta-scraper
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.SCRAPER_IMAGE }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push scraper image
      uses: docker/build-push-action@v6
      with:
        context: .
        target: production
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta-scraper.outputs.tags }}
        labels: ${{ steps.meta-scraper.outputs.labels }}
        cache-from: type=gha,scope=scraper
        cache-to: type=gha,mode=max,scope=scraper

    - name: Summary - Scraper image
      run: |
        echo "## ðŸ¥ Hospital Scraper Image" >> $GITHUB_STEP_SUMMARY
        echo "Pushed tags:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.meta-scraper.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  build-and-push-ui:
    name: Build UI Image
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.ui == 'true'
    permissions:
      contents: read
      packages: write
      actions: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for UI
      id: meta-ui
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.UI_IMAGE }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push UI image
      uses: docker/build-push-action@v6
      with:
        context: ./ui
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta-ui.outputs.tags }}
        labels: ${{ steps.meta-ui.outputs.labels }}
        cache-from: type=gha,scope=ui
        cache-to: type=gha,mode=max,scope=ui

    - name: Summary - UI image
      run: |
        echo "## ðŸ–¥ï¸ Hospital UI Image" >> $GITHUB_STEP_SUMMARY
        echo "Pushed tags:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.meta-ui.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-push-scraper, build-and-push-ui]
    if: always()
    steps:
    - name: Create deployment summary
      run: |
        echo "# ðŸš€ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Build Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.detect-changes.outputs.scraper }}" == "true" ]; then
          echo "âœ… **Hospital Scraper**: Built and pushed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "ghcr.io/${{ env.SCRAPER_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "â­ï¸ **Hospital Scraper**: Skipped (no changes detected)" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.detect-changes.outputs.ui }}" == "true" ]; then
          echo "âœ… **Hospital UI**: Built and pushed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "ghcr.io/${{ env.UI_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "â­ï¸ **Hospital UI**: Skipped (no changes detected)" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ³ Docker Compose" >> $GITHUB_STEP_SUMMARY
        echo "Update your docker-compose.yml to use these images and deploy!" >> $GITHUB_STEP_SUMMARY