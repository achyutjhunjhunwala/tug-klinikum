name: Build and Push Docker Images

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  SCRAPER_IMAGE: ${{ github.repository }}
  UI_IMAGE: ${{ github.repository }}-ui

jobs:
  build-and-push-scraper:
    name: Build Scraper Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      actions: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for scraper
      id: meta-scraper
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.SCRAPER_IMAGE }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push scraper image
      uses: docker/build-push-action@v5
      with:
        context: .
        target: production
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta-scraper.outputs.tags }}
        labels: ${{ steps.meta-scraper.outputs.labels }}
        cache-from: type=gha,scope=scraper
        cache-to: type=gha,mode=max,scope=scraper

    - name: Summary - Scraper image
      run: |
        echo "## ðŸ¥ Hospital Scraper Image" >> $GITHUB_STEP_SUMMARY
        echo "Pushed tags:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.meta-scraper.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  build-and-push-ui:
    name: Build UI Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      actions: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for UI
      id: meta-ui
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.UI_IMAGE }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push UI image
      uses: docker/build-push-action@v5
      with:
        context: ./ui
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta-ui.outputs.tags }}
        labels: ${{ steps.meta-ui.outputs.labels }}
        cache-from: type=gha,scope=ui
        cache-to: type=gha,mode=max,scope=ui

    - name: Summary - UI image
      run: |
        echo "## ðŸ–¥ï¸ Hospital UI Image" >> $GITHUB_STEP_SUMMARY
        echo "Pushed tags:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.meta-ui.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-and-push-scraper, build-and-push-ui]
    if: always()
    steps:
    - name: Create deployment summary
      run: |
        echo "# ðŸš€ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Build Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        SCRAPER_STATUS="${{ needs.build-and-push-scraper.result }}"
        UI_STATUS="${{ needs.build-and-push-ui.result }}"

        if [ "$SCRAPER_STATUS" == "success" ]; then
          echo "âœ… **Hospital Scraper**: Built and pushed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "ghcr.io/${{ env.SCRAPER_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "ghcr.io/${{ env.SCRAPER_IMAGE }}:${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Hospital Scraper**: Build failed" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "$UI_STATUS" == "success" ]; then
          echo "âœ… **Hospital UI**: Built and pushed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "ghcr.io/${{ env.UI_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "ghcr.io/${{ env.UI_IMAGE }}:${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Hospital UI**: Build failed" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ³ Docker Images" >> $GITHUB_STEP_SUMMARY
        echo "Images published for release: **${{ github.ref_name }}**" >> $GITHUB_STEP_SUMMARY